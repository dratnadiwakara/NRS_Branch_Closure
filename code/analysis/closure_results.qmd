---
title: "Branch Closure Results"
format:
 html:
   page-layout: full
   code-overflow: scroll
   code-fold: true
   number-sections: true
   self-contained: true
editor: source
execute: 
 warning: false
 echo: true
---

# Setup

```{r}
#| label: setup
#| message: false

rm(list = ls())
gc()
library(data.table)
library(dplyr)
library(fixest)
library(modelsummary)
library(ggplot2)
library(lubridate)
library(xtable)
library(DescTools)
library(stringr)
library(scales)

# Load summary statistics function
source('https://raw.githubusercontent.com/dratnadiwakara/r-utilities/refs/heads/main/summary_stat_tables.R')

data_dir <- "C:/OneDrive/data/nrs_branch_closure"

# Load deposit beta results from three rate cycles
beta_cycles <- readRDS(file.path(data_dir, "deposit_beta_results.rds"))
```

# Data Preparation

## Define Large Banks

Define large banks using CPI-adjusted asset cutoff (\$100M in 2024 dollars):

```{r}
#| label: define-large-banks

# Load CPI data for inflation adjustment
# Source: FRED CPIAUCSL series
# library(quantmod)
# cpi <- getSymbols("CPIAUCSL",src="FRED",auto.assign = F)
# cpi <- data.table(date=index(cpi),CPI=coredata(cpi))
# cpi <- cpi %>% mutate(year=year(date)) %>%
#        group_by(year) %>%
#       summarize(CPI=last(CPI.CPIAUCSL)) %>% ungroup() %>% data.table()
# saveRDS(cpi,"../data/cpi.rds")

cpi <- readRDS(file.path(data_dir, "cpi.rds"))
cpi[, adj_ratio := CPI / CPI[year == 2024]]
cpi[, asset_cutoff := adj_ratio * 100000000]

# Get all bank-level data across cycles
all_banks <- rbindlist(lapply(names(beta_cycles), function(cycle_name) {
  dt <- copy(beta_cycles[[cycle_name]]$data)
  dt[, cycle := cycle_name]
  # Add year for each cycle (using end year)
  dt[, year := ifelse(cycle == "cycle_0406", 2006,
                     ifelse(cycle == "cycle_1619", 2019, 2023))]
  return(dt)
}))

# Merge with CPI cutoffs
all_banks <- merge(all_banks, cpi[, .(year, asset_cutoff)], by = "year", all.x = TRUE)

# Define large banks
large_banks <- unique(all_banks[bank_assets > asset_cutoff]$ID_RSSD)
```

## Prepare Branch Sample

Load branch sample and calculate deposit betas using predictions from bank-level regressions:

```{r}
#| label: prepare-branch-sample


# Load branch-level data
branch_sample <- readRDS(file.path(data_dir, "branch_closure_analysis_sample.rds"))

# Add large_bank indicator
branch_sample[, large_bank := ifelse(RSSDID %in% large_banks, 1, 0)]

# Create factor variables needed for prediction
branch_sample[, factor_age_bin := as.factor(age_bin)]

# Predict deposit expense changes for each branch using each cycle's regression
for(i in 1:length(beta_cycles)) {
  cycle_nm <- names(beta_cycles)[i]
  cycle_data <- beta_cycles[[cycle_nm]]$data
  branch_sample[, pred_int_exp_chg := predict(beta_cycles[[i]]$reg, newdata = branch_sample)]
  setnames(branch_sample, "pred_int_exp_chg", paste0("pred_int_exp_chg_", cycle_nm))
}

# Calculate deposit beta based on year and rate changes
# Rate changes: 2004-06: 3.5pp, 2016-19: 2.5pp, 2022-23: 4.0pp
branch_sample[, deposit_beta := ifelse(yr <= 2014, pred_int_exp_chg_cycle_0406 / 3.5,
                                      ifelse(yr <= 2019, pred_int_exp_chg_cycle_1619 / 2.5,
                                             pred_int_exp_chg_cycle_2224 / 4))]

# Calculate deposit franchise value per dollar


# Create rate cycle variable
branch_sample[, rate_cycle := ifelse(yr >= 2004 & yr <= 2006, "1early",
                                    ifelse(yr >= 2016 & yr <= 2019, "2mid",
                                    ifelse(yr >= 2022 & yr <= 2023, "3late", NA)))]


# Create fixed effect variables
branch_sample[, state_yr := paste0(substr(STCNTYBR, 1, 2), "_", yr)]
branch_sample[, county_yr := paste0(STCNTYBR, "_", yr)]
branch_sample[, bank_yr := paste0(RSSDID, "_", yr)]


cat("Branch sample prepared with", nrow(branch_sample), "observations\n")
cat("Observations by rate cycle:\n")
print(table(branch_sample$rate_cycle, useNA = "ifany"))
```

## Summary Statistics by Bank Size

```{r}
#| label: tbl-bank-stats
#| tbl-cap: "Bank-Level Characteristics by Size and Cycle"
#| results: asis

# Store results in list
result_tables <- list()

# Create table for each cycle
for(i in 1:length(beta_cycles)) {
  cat("\n### Cycle:", names(beta_cycles)[[i]], "\n\n")
  
  temp <- copy(beta_cycles[[i]]$data)
  temp[, large_bank := ifelse(ID_RSSD %in% large_banks, 1, 0)]
  temp[, family_income := floor(family_income / 1000)]  # Convert to thousands
  
  # Rename variables for display
  setnames(temp,
           c("deposit_beta", "age", "college_frac", "dividend_frac", "family_income", 
             "sophisticated_frac", "bank_hhi", "population_density"),
           new_names <- c("Deposit beta", "Age", "College educated fraction", 
                         "Stock market participation frac", "Family income (000)", 
                         "Frac. deposits in sophisticated zipcodes", "HHI", 
                         "Deposit-weighted Pop. density"))
  
  cat("Number of banks by size:\n")
  print(table(temp$large_bank))
  cat("\n")
  
  # Summary stats for large banks
  temp1 <- summary_stats_function(temp[large_bank == 1], new_names)
  temp1 <- temp1 %>% select(-P25, -P50, -P75, -Obs)
  
  # Summary stats for small banks
  temp2 <- summary_stats_function(temp[large_bank == 0], new_names)
  temp2 <- temp2 %>% select(-P25, -P50, -P75, -Obs)
  
  # Merge tables
  result_tables[[paste0('bank_stats_', names(beta_cycles)[[i]])]] <- 
    merge(temp1, temp2, by = "Variable")
  
  # Print table (text format)
  md_table((result_tables[[paste0('bank_stats_', names(beta_cycles)[[i]])]]))
  
  # LaTeX version (uncomment to use)
  # print(xtable(result_tables[[paste0('bank_stats_', names(beta_cycles)[[i]])]]),
  #       table.placement = NULL, floating = FALSE, include.rownames = FALSE,
  #       comment = FALSE, scalebox = 0.8, latex.environments = "center")
  
  cat("\n\n")
}
```

# Deposit Beta Regressions

Table showing how depositor characteristics predict deposit beta sensitivity:

```{r}
#| label: tbl-deposit-beta-regs
#| tbl-cap: "Deposit Beta Regressions"

# Coefficient dictionary for display names
covariate_labels_dict <- c(
  "college_frac" = "College frac",
  "dividend_frac" = "Stock market frac",
  "log(family_income)" = "Log(Income)",
  "sophisticated_frac" = "Sophisticated frac",
  "factor_age_bin2" = "Age bin 2",
  "factor_age_bin3" = "Age bin 3",
  "factor_age_bin4" = "Age bin 4",
  "bank_hhi" = "Bank HHI",
  "log(bank_assets)" = "Log(Assets)",
  "population_density" = "Pop. density",
  "trans_accts_frac_assets" = "Trans. accounts",
  "uninsured_deposits_frac" = "Uninsured deposits"
)

# Create table using etable
md_table(etable(
  beta_cycles$cycle_0406$reg, beta_cycles$cycle_1619$reg, beta_cycles$cycle_2224$reg,
  beta_cycles$cycle_0406$reg_sophisticated, beta_cycles$cycle_1619$reg_sophisticated, beta_cycles$cycle_2224$reg_sophisticated,
  se.below = TRUE,
  signif.code = c("***" = 0.01, "**" = 0.05, "*" = 0.10),
  headers = list("Early Cycle" = 1, "Mid Cycle" = 1, "Late Cycle" = 1, 
                 "Early Cycle" = 1, "Mid Cycle" = 1, "Late Cycle" = 1),
  dict = covariate_labels_dict,
  depvar = FALSE
))

# LaTeX version with AER style (uncomment to use)
# etable(
#   beta_cycles$cycle_0406$reg, beta_cycles$cycle_1619$reg, beta_cycles$cycle_2224$reg,
#   beta_cycles$cycle_0406$reg_sophisticated, beta_cycles$cycle_1619$reg_sophisticated, beta_cycles$cycle_2224$reg_sophisticated,
#   se.below = TRUE,
#   signif.code = c("***" = 0.01, "**" = 0.05, "*" = 0.10),
#   headers = list("Early Cycle" = 1, "Mid Cycle" = 1, "Late Cycle" = 1, 
#                  "Early Cycle" = 1, "Mid Cycle" = 1, "Late Cycle" = 1),
#   dict = covariate_labels_dict,
#   depvar = FALSE,
#   tex = TRUE,
#   style.tex = style.tex("aer")
# )
```

# Distribution of Deposit Betas

## Bank-Level

Distribution of deposit betas across cycles, comparing large and small banks:

```{r}
#| label: fig-beta-density-bank
#| fig-cap: "Bank-Level Deposit Beta Distribution"
#| fig-width: 8
#| fig-height: 4

# Combine data from all cycles
beta_density <- data.table()
for(i in 1:length(beta_cycles)) {
  cycle_nm <- names(beta_cycles)[[i]]
  temp <- beta_cycles[[i]]$data[, .(ID_RSSD, deposit_beta)]
  temp[, large_bank := ifelse(ID_RSSD %in% large_banks, 1, 0)]
  temp[, cycle := cycle_nm]
  beta_density <- rbind(beta_density, temp)
}

# Create density plot
g <- ggplot(beta_density, aes(x = deposit_beta, fill = factor(large_bank))) +
  geom_density(alpha = 0.5) +
  facet_wrap(~cycle, labeller = as_labeller(c(
    "cycle_0406" = "Early Cycle",
    "cycle_1619" = "Mid Cycle",
    "cycle_2224" = "Late Cycle"
  ))) +
  scale_x_continuous(n.breaks = 4) +
  scale_fill_manual(
    values = c("1" = "dodgerblue4", "0" = "tan2"),
    labels = c("1" = "Large banks", "0" = "Small banks")
  ) +
  labs(x = "", y = "") +
  theme_minimal() +
  theme(
    legend.title = element_blank(),
    legend.position = "bottom",
    axis.text.y = element_blank(),
    panel.spacing = unit(2, "lines"),
    strip.text = element_text(face = "bold")
  )

print(g)

# Uncomment to save
# ggsave(file.path(data_dir, "../figures/beta_density_bank.jpg"), g, 
#        width = 5, height = 3)
```

## Branch-Level

Distribution of deposit betas at the branch level:

```{r}
#| label: fig-beta-density-branch
#| fig-cap: "Branch-Level Deposit Beta Distribution"
#| fig-width: 8
#| fig-height: 4

# Calculate branch-level average deposit beta by cycle
beta_density_branch <- branch_sample[!is.na(rate_cycle), 
                                     .(deposit_beta = mean(deposit_beta, na.rm = TRUE)), 
                                     by = .(rate_cycle, large_bank, UNINUMBR)]

# Winsorize at 0.1% and 99.9% by cycle
beta_density_branch[, `:=`(
  q1 = quantile(deposit_beta, probs = 0.001, na.rm = TRUE),
  q2 = quantile(deposit_beta, probs = 0.999, na.rm = TRUE)
), by = rate_cycle]

beta_density_branch[, deposit_beta := ifelse(deposit_beta < q1, q1, 
                                             ifelse(deposit_beta > q2, q2, deposit_beta))]

# Create density plot
g <- ggplot(beta_density_branch, aes(x = deposit_beta, fill = factor(large_bank))) +
  geom_density(alpha = 0.5) +
  facet_wrap(~rate_cycle, labeller = as_labeller(c(
    "1early" = "Early Cycle",
    "2mid" = "Mid Cycle",
    "3late" = "Late Cycle"
  ))) +
  scale_x_continuous(n.breaks = 4) +
  scale_fill_manual(
    values = c("1" = "dodgerblue4", "0" = "tan2"),
    labels = c("1" = "Large banks", "0" = "Small banks")
  ) +
  labs(x = "", y = "") +
  theme_minimal() +
  theme(
    legend.title = element_blank(),
    legend.position = "bottom",
    axis.text.y = element_blank(),
    panel.spacing = unit(2, "lines"),
    strip.text = element_text(face = "bold")
  )

print(g)

# Uncomment to save
# ggsave(file.path(data_dir, "../figures/beta_density_branch.jpg"), g, 
#        width = 5, height = 3)
```

# Beta Correlations Across Cycles

## Branch-Level Correlations

### Mid Cycle vs Late Cycle

Scatter plot showing correlation of deposit betas between mid cycle (2016-2019) and late cycle (2022-2024) at the branch level:

```{r}
#| label: fig-beta-correlation-branch-mid-late
#| fig-cap: "Branch-Level Deposit Beta: Mid Cycle vs Late Cycle"
#| fig-width: 4
#| fig-height: 3.5

# Prepare data: get deposit betas for 2019-2020
temp <- branch_sample[yr %in% 2019:2020, c("UNINUMBR", "yr", "deposit_beta", "large_bank")]
temp <- dcast(temp, UNINUMBR + large_bank ~ yr, value.var = "deposit_beta", fun.aggregate = mean)
names(temp) <- c("UNINUMBR", "large_bank", "cycle1619", "cycle2224")

# Create scatter plot
g <- ggplot(temp[cycle1619 > 0.08 & cycle1619 < 0.4], aes(x = cycle1619, y = cycle2224)) +
  geom_point(aes(color = factor(large_bank)), alpha = 0.2) +
  geom_smooth(method = "lm") +
  geom_abline(intercept = 0, slope = 1, linetype = "dashed") +
  scale_color_manual(
    values = c("1" = "dodgerblue4", "0" = "tan2"),
    labels = c("1" = "Large banks", "0" = "Small banks")
  ) +
  labs(x = "Deposit Beta - Mid Cycle", y = "Deposit Beta - Late Cycle") +
  theme_minimal() +
  theme(legend.position = "bottom", legend.title = element_blank())

print(g)

# Uncomment to save
# ggsave(file.path(data_dir, "../figures/df_scatter_branch_mid_late.jpg"), g, 
#        width = 4, height = 3.5)
```

### Early Cycle vs Mid Cycle

Scatter plot showing correlation of deposit betas between early cycle (2004-2006) and mid cycle (2016-2019) at the branch level:

```{r}
#| label: fig-beta-correlation-branch-early-mid
#| fig-cap: "Branch-Level Deposit Beta: Early Cycle vs Mid Cycle"
#| fig-width: 4
#| fig-height: 3.5

# Prepare data: get deposit betas for 2006 and 2019
temp <- branch_sample[yr %in% c(2006, 2019) & is.finite(deposit_beta), 
                      c("UNINUMBR", "yr", "deposit_beta", "large_bank")]
temp <- dcast(temp, UNINUMBR + large_bank ~ yr, value.var = "deposit_beta", fun.aggregate = mean)
names(temp) <- c("UNINUMBR", "large_bank", "cycle0406", "cycle1619")

# Create scatter plot
g <- ggplot(temp, aes(x = cycle0406, y = cycle1619)) +
  geom_point(aes(color = factor(large_bank)), alpha = 0.2) +
  geom_smooth(method = "lm") +
  geom_abline(intercept = 0, slope = 1, linetype = "dashed") +
  scale_color_manual(
    values = c("1" = "dodgerblue4", "0" = "tan2"),
    labels = c("1" = "Large banks", "0" = "Small banks")
  ) +
  labs(x = "Deposit Beta - Early Cycle", y = "Deposit Beta - Mid Cycle") +
  theme_minimal() +
  theme(legend.position = "bottom", legend.title = element_blank())

print(g)

# Uncomment to save
# ggsave(file.path(data_dir, "../figures/df_scatter_branch_early_mid.jpg"), g, 
#        width = 4, height = 3.5)
```

## Bank-Level Correlations

### Early Cycle vs Mid Cycle

Scatter plot showing correlation of deposit betas between early and mid cycles at the bank level:

```{r}
#| label: fig-beta-correlation-bank-early-mid
#| fig-cap: "Bank-Level Deposit Beta: Early Cycle vs Mid Cycle"
#| fig-width: 4
#| fig-height: 3.5

# Prepare bank-level data across all cycles
beta_density_bank <- data.table()
for(i in 1:length(beta_cycles)) {
  cycle_nm <- names(beta_cycles)[[i]]
  cycle <- beta_cycles[[i]]
  temp <- cycle$data[, .(ID_RSSD, deposit_beta)]
  temp[, large_bank := ifelse(ID_RSSD %in% large_banks, 1, 0)]
  temp[, cycle := cycle_nm]
  beta_density_bank <- rbind(beta_density_bank, temp)
}

# Reshape to wide format
beta_density_bank <- dcast(beta_density_bank, ID_RSSD + large_bank ~ cycle, 
                           value.var = "deposit_beta", fun.aggregate = mean)
beta_density_bank <- beta_density_bank[complete.cases(beta_density_bank)]
setnames(beta_density_bank, c("cycle_0406", "cycle_1619", "cycle_2224"), 
         c("early", "mid", "late"))

# Create scatter plot: early vs mid
g1 <- ggplot(beta_density_bank, aes(x = early, y = mid)) +
  geom_point(aes(color = factor(large_bank), size = factor(large_bank)), alpha = 0.5) +
  geom_smooth(method = "lm") +
  geom_abline(intercept = 0, slope = 1, linetype = "dashed") +
  scale_size_manual(
    values = c("1" = 2, "0" = 1),
    labels = c("1" = "Large banks", "0" = "Small banks")
  ) +
  scale_color_manual(
    values = c("1" = "dodgerblue4", "0" = "tan2"),
    labels = c("1" = "Large banks", "0" = "Small banks")
  ) +
  labs(x = "Deposit Beta - Early Cycle", y = "Deposit Beta - Mid Cycle") +
  theme_minimal() +
  theme(legend.position = "bottom", legend.title = element_blank())

print(g1)

# Uncomment to save
# ggsave(file.path(data_dir, "../figures/df_scatter_bank_early_mid.jpg"), g1, 
#        width = 4, height = 3.5)
```

### Mid Cycle vs Late Cycle

Scatter plot showing correlation of deposit betas between mid and late cycles at the bank level:

```{r}
#| label: fig-beta-correlation-bank-mid-late
#| fig-cap: "Bank-Level Deposit Beta: Mid Cycle vs Late Cycle"
#| fig-width: 4
#| fig-height: 3.5

# Create scatter plot: mid vs late
g2 <- ggplot(beta_density_bank, aes(x = mid, y = late)) +
  geom_point(aes(color = factor(large_bank), size = factor(large_bank)), alpha = 0.5) +
  geom_smooth(method = "lm") +
  geom_abline(intercept = 0, slope = 1, linetype = "dashed") +
  scale_size_manual(
    values = c("1" = 2, "0" = 1),
    labels = c("1" = "Large banks", "0" = "Small banks")
  ) +
  scale_color_manual(
    values = c("1" = "dodgerblue4", "0" = "tan2"),
    labels = c("1" = "Large banks", "0" = "Small banks")
  ) +
  labs(x = "Deposit Beta - Mid Cycle", y = "Deposit Beta - Late Cycle") +
  theme_minimal() +
  theme(legend.position = "bottom", legend.title = element_blank())

print(g2)

# Uncomment to save
# ggsave(file.path(data_dir, "../figures/df_scatter_bank_mid_late.jpg"), g2, 
#        width = 4, height = 3.5)
```

# Deposit Beta and Closure Rates (Univariate)

Examining the relationship between deposit beta deciles and branch closure rates across different time periods:

```{r}
#| label: fig-univariate-beta-closure
#| fig-cap: "Branch Closure Rates by Deposit Beta Decile Across Cycles"
#| fig-width: 5
#| fig-height: 3.5

# Prepare data with cycles and beta deciles
temp <- copy(branch_sample)
temp[, cycle := ifelse(yr >= 2020, 1, ifelse(yr >= 2014, 2, 3))]
temp[, beta_q := ntile(deposit_beta, 10), by = .(yr)]

# Calculate closure rates by beta decile for each cycle
temp1 <- temp[yr %in% 2020:2023, .(frac_branches_closed = mean(closed)), by = beta_q]
temp1[, cycle := "Late Cycle"]

temp2 <- temp[yr %in% 2015:2019, .(frac_branches_closed = mean(closed, na.rm = TRUE)), by = beta_q]
temp2[, cycle := "Mid Cycle"]

temp3 <- temp[yr %in% 2001:2014, .(frac_branches_closed = mean(closed, na.rm = TRUE)), by = beta_q]
temp3[, cycle := "Early Cycle"]

# Combine and winsorize
temp <- rbind(temp1, temp2, temp3)
temp[, frac_branches_closed := Winsorize(frac_branches_closed, 
                                         quantile(frac_branches_closed, probs = c(0.05, 0.95), na.rm = TRUE)), 
     by = .(beta_q, cycle)]

# Create plot
g <- ggplot(temp, aes(x = beta_q, y = frac_branches_closed * 100, color = cycle)) +
  geom_point(size = 3, alpha = 0.75, aes(shape = cycle)) +
  scale_x_continuous(n.breaks = 10) +
  scale_color_manual(
    values = c("Late Cycle" = "dodgerblue4",
               "Mid Cycle" = "tan2",
               "Early Cycle" = "gray")
  ) +
  ylim(c(1, 6)) +
  theme_minimal() +
  labs(x = "Deposit Beta Decile", y = "Percent of branches closed (%)") +
  theme(legend.position = "bottom", legend.title = element_blank())

print(g)

# Uncomment to save
# ggsave(file.path(data_dir, "../figures/univar_branch.jpg"), g, 
#        width = 5, height = 3.5)
```

# Descriptive Statistics: Branch Closure Sample

Summary statistics for the branch closure analysis sample, comparing large and small banks across different time periods:

## Panel A: Large Banks

```{r}
#| label: tbl-desc-stats-large-banks
#| tbl-cap: "Descriptive Statistics - Large Banks"
#| results: asis

# Prepare data
temp <- copy(branch_sample[is.finite(deposit_beta) & DEPSUMBR > 0 & is.finite(DEPSUMBR)])
temp[, lag_branch_deposit_amount := floor(lag_branch_deposit_amount / 1000)]
temp[, log_deposits := log(DEPSUMBR)]
# Remove any remaining -Inf values
temp <- temp[is.finite(log_deposits)]

# Rename variables
setnames(temp,
         c("closed", "deposit_beta", "lag_branch_deposit_amount", "log_deposits", 
           "lag_county_deposit_gr", "lag_hmda_mtg_amt_gr", "lag_cra_loan_amount_amt_lt_1m_gr", 
           "lag_establishment_gr", "lag_payroll_gr", "same_zip_prior_3yr_branches", 
           "legacy_branch", "population_density", "lmi"),
         new_names <- c("Closed", "Deposit Beta", "Deposits (mn)", "log(Deposits)", 
                        "Deposit 3yr growth", "Mortgage 3yr growth", "CRA 3yr growth", 
                        "Establishments 3yr growth", "Payroll 3yr growth", 
                        "Acq. branch/presence", "Branch owned 3plus years", 
                        "Population density (1k km)", "Low to Moderate Income Area"))

# Calculate within-FE standard deviations for mid cycle (2019)
temp_df_mid <- copy(branch_sample[is.finite(deposit_beta) & DEPSUMBR > 0 & is.finite(DEPSUMBR) & yr == 2019 & large_bank == 1])
temp_df_mid[, log_deposits := log(DEPSUMBR)]
temp_df_mid <- temp_df_mid[is.finite(log_deposits)]

reg_beta <- feols(deposit_beta ~ 0 | county_yr + bank_yr, temp_df_mid)
temp_df_mid[, pred_deposit_beta := predict(reg_beta, newdata = temp_df_mid)]
temp_df_mid[, resid_deposit_beta := deposit_beta - pred_deposit_beta]
sd_within_beta_mid <- sd(temp_df_mid$resid_deposit_beta, na.rm = TRUE)

reg_log <- feols(log_deposits ~ 0 | county_yr + bank_yr, temp_df_mid)
temp_df_mid[, pred_log_deposits := predict(reg_log, newdata = temp_df_mid)]
temp_df_mid[, resid_log_deposits := log_deposits - pred_log_deposits]
sd_within_log_mid <- sd(temp_df_mid$resid_log_deposits, na.rm = TRUE)

# Calculate within-FE standard deviations for early cycle (2012)
temp_df_early <- copy(branch_sample[is.finite(deposit_beta) & DEPSUMBR > 0 & is.finite(DEPSUMBR) & yr == 2012 & large_bank == 1])
temp_df_early[, log_deposits := log(DEPSUMBR)]
temp_df_early <- temp_df_early[is.finite(log_deposits)]

reg_beta <- feols(deposit_beta ~ 0 | county_yr + bank_yr, temp_df_early)
temp_df_early[, pred_deposit_beta := predict(reg_beta, newdata = temp_df_early)]
temp_df_early[, resid_deposit_beta := deposit_beta - pred_deposit_beta]
sd_within_beta_early <- sd(temp_df_early$resid_deposit_beta, na.rm = TRUE)

reg_log <- feols(log_deposits ~ 0 | county_yr + bank_yr, temp_df_early)
temp_df_early[, pred_log_deposits := predict(reg_log, newdata = temp_df_early)]
temp_df_early[, resid_log_deposits := log_deposits - pred_log_deposits]
sd_within_log_early <- sd(temp_df_early$resid_log_deposits, na.rm = TRUE)

# Mid cycle stats (2019)
temp1 <- summary_stats_function(temp[large_bank == 1 & yr == 2019], new_names)
temp1 <- temp1 %>% select(-P25, -P50, -P75, -Obs) %>% data.table()
temp1[, `SD (within)` := NA_real_]
temp1[Variable == "Deposit Beta", `SD (within)` := sd_within_beta_mid]
temp1[Variable == "log(Deposits)", `SD (within)` := sd_within_log_mid]
temp1 <- temp1[, .(Variable, Mean, SD, `SD (within)`, P10, P90)]

# Early cycle stats (2012)
temp2 <- summary_stats_function(temp[large_bank == 1 & yr == 2012], new_names)
temp2 <- temp2 %>% select(-P25, -P50, -P75, -Obs) %>% data.table()
temp2[, `SD (within)` := NA_real_]
temp2[Variable == "Deposit Beta", `SD (within)` := sd_within_beta_early]
temp2[Variable == "log(Deposits)", `SD (within)` := sd_within_log_early]
temp2 <- temp2[, .(Variable, Mean, SD, `SD (within)`, P10, P90)]

# Merge tables
result_large <- merge(temp1, temp2, by = "Variable", suffixes = c(".mid", ".early"))

# Reorder variables
variable_order <- c('Closed', 'Deposit Beta', 'log(Deposits)', 
                   'Acq. branch/presence', 'Branch owned 3plus years',
                   'Deposit 3yr growth', 'CRA 3yr growth', 
                   'Establishments 3yr growth', 'Low to Moderate Income Area',
                   'Mortgage 3yr growth', 'Payroll 3yr growth', 
                   'Population density (1k km)')

result_large <- result_large[order(factor(Variable, levels = variable_order))]

# Get observation counts
obs_mid <- nrow(temp[large_bank == 1 & yr == 2019])
obs_early <- nrow(temp[large_bank == 1 & yr == 2012])

# Print table
cat("\\begin{table}[htbp]\n")
cat("\\centering\n")
cat("\\caption{Descriptive Statistics - Large Banks}\n")
cat("\\begin{tabular}{l*{10}{c}}\n")
cat("\\hline\\hline\n")
cat("& \\multicolumn{5}{c}{Mid Cycle; Year 2019; Obs =", obs_mid, "} & \\multicolumn{5}{c}{Early Cycle; Year 2012; Obs =", obs_early, "} \\\\\n")
cat("Variable & Mean & SD & SD (within) & P10 & P90 & Mean & SD & SD (within) & P10 & P90 \\\\\n")
cat("\\hline\n")

for(i in 1:nrow(result_large)) {
  row <- result_large[i]
  cat(row$Variable, "&", 
      sprintf("%.2f", row$Mean.mid), "&",
      sprintf("%.2f", row$SD.mid), "&",
      ifelse(is.na(row$`SD (within).mid`), "", sprintf("%.3f", row$`SD (within).mid`)), "&",
      sprintf("%.2f", row$P10.mid), "&",
      sprintf("%.2f", row$P90.mid), "&",
      sprintf("%.2f", row$Mean.early), "&",
      sprintf("%.2f", row$SD.early), "&",
      ifelse(is.na(row$`SD (within).early`), "", sprintf("%.3f", row$`SD (within).early`)), "&",
      sprintf("%.2f", row$P10.early), "&",
      sprintf("%.2f", row$P90.early), "\\\\\n")
}

cat("\\hline\\hline\n")
cat("\\end{tabular}\n")
cat("\\end{table}\n")

# Also print as kable for viewing
md_table(result_large)
```

## Panel B: Small Banks

```{r}
#| label: tbl-desc-stats-small-banks
#| tbl-cap: "Descriptive Statistics - Small Banks"
#| results: asis

# Calculate within-FE standard deviations for mid cycle (2019)
temp_df_mid <- copy(branch_sample[is.finite(deposit_beta) & DEPSUMBR > 0 & is.finite(DEPSUMBR) & yr == 2019 & large_bank == 0])
temp_df_mid[, log_deposits := log1p(DEPSUMBR)]
temp_df_mid <- temp_df_mid[is.finite(log_deposits)]

reg_beta <- feols(deposit_beta ~ 0 | county_yr + bank_yr, temp_df_mid)
temp_df_mid[, pred_deposit_beta := predict(reg_beta, newdata = temp_df_mid)]
temp_df_mid[, resid_deposit_beta := deposit_beta - pred_deposit_beta]
sd_within_beta_mid <- sd(temp_df_mid$resid_deposit_beta, na.rm = TRUE)

reg_log <- feols(log_deposits ~ 0 | county_yr + bank_yr, temp_df_mid)
temp_df_mid[, pred_log_deposits := predict(reg_log, newdata = temp_df_mid)]
temp_df_mid[, resid_log_deposits := log_deposits - pred_log_deposits]
sd_within_log_mid <- sd(temp_df_mid$resid_log_deposits, na.rm = TRUE)

# Calculate within-FE standard deviations for early cycle (2012)
temp_df_early <- copy(branch_sample[is.finite(deposit_beta) & DEPSUMBR > 0 & is.finite(DEPSUMBR) & yr == 2012 & large_bank == 0])
temp_df_early[, log_deposits := log(DEPSUMBR)]
temp_df_early <- temp_df_early[is.finite(log_deposits)]

reg_beta <- feols(deposit_beta ~ 0 | county_yr + bank_yr, temp_df_early)
temp_df_early[, pred_deposit_beta := predict(reg_beta, newdata = temp_df_early)]
temp_df_early[, resid_deposit_beta := deposit_beta - pred_deposit_beta]
sd_within_beta_early <- sd(temp_df_early$resid_deposit_beta, na.rm = TRUE)

reg_log <- feols(log_deposits ~ 0 | county_yr + bank_yr, temp_df_early)
temp_df_early[, pred_log_deposits := predict(reg_log, newdata = temp_df_early)]
temp_df_early[, resid_log_deposits := log_deposits - pred_log_deposits]
sd_within_log_early <- sd(temp_df_early$resid_log_deposits, na.rm = TRUE)

# Mid cycle stats (2019)
temp1 <- summary_stats_function(temp[large_bank == 0 & yr == 2019 & DEPSUMBR>0], new_names)
temp1 <- temp1 %>% select(-P25, -P50, -P75, -Obs) %>% data.table()
temp1[, `SD (within)` := NA_real_]
temp1[Variable == "Deposit Beta", `SD (within)` := sd_within_beta_mid]
temp1[Variable == "log(Deposits)", `SD (within)` := sd_within_log_mid]
temp1 <- temp1[, .(Variable, Mean, SD, `SD (within)`, P10, P90)]

# Early cycle stats (2012)
temp2 <- summary_stats_function(temp[large_bank == 0 & yr == 2012 & DEPSUMBR>0], new_names)
temp2 <- temp2 %>% select(-P25, -P50, -P75, -Obs) %>% data.table()
temp2[, `SD (within)` := NA_real_]
temp2[Variable == "Deposit Beta", `SD (within)` := sd_within_beta_early]
temp2[Variable == "log(Deposits)", `SD (within)` := sd_within_log_early]
temp2 <- temp2[, .(Variable, Mean, SD, `SD (within)`, P10, P90)]

# Merge tables
result_small <- merge(temp1, temp2, by = "Variable", suffixes = c(".mid", ".early"))

# Reorder variables
result_small <- result_small[order(factor(Variable, levels = variable_order))]

# Get observation counts
obs_mid <- nrow(temp[large_bank == 0 & yr == 2019 & DEPSUMBR>0])
obs_early <- nrow(temp[large_bank == 0 & yr == 2012 & DEPSUMBR>0])

# Print table
cat("\\begin{table}[htbp]\n")
cat("\\centering\n")
cat("\\caption{Descriptive Statistics - Small Banks}\n")
cat("\\begin{tabular}{l*{10}{c}}\n")
cat("\\hline\\hline\n")
cat("& \\multicolumn{5}{c}{Mid Cycle; Year 2019; Obs =", obs_mid, "} & \\multicolumn{5}{c}{Early Cycle; Year 2012; Obs =", obs_early, "} \\\\\n")
cat("Variable & Mean & SD & SD (within) & P10 & P90 & Mean & SD & SD (within) & P10 & P90 \\\\\n")
cat("\\hline\n")

for(i in 1:nrow(result_small)) {
  row <- result_small[i]
  cat(row$Variable, "&", 
      sprintf("%.2f", row$Mean.mid), "&",
      sprintf("%.2f", row$SD.mid), "&",
      ifelse(is.na(row$`SD (within).mid`), "", sprintf("%.3f", row$`SD (within).mid`)), "&",
      sprintf("%.2f", row$P10.mid), "&",
      sprintf("%.2f", row$P90.mid), "&",
      sprintf("%.2f", row$Mean.early), "&",
      sprintf("%.2f", row$SD.early), "&",
      ifelse(is.na(row$`SD (within).early`), "", sprintf("%.3f", row$`SD (within).early`)), "&",
      sprintf("%.2f", row$P10.early), "&",
      sprintf("%.2f", row$P90.early), "\\\\\n")
}

cat("\\hline\\hline\n")
cat("\\end{tabular}\n")
cat("\\end{table}\n")

# Also print as kable for viewing
md_table(result_small)
```

# Branch Closure Analysis

## Define Control Variables

Set up control variable specifications for closure regressions:

```{r}
#| label: define-controls

# State-level controls with extensive covariates
setFixest_fml(
  ..ctrl_state_closure = ~ log(lag_branch_deposit_amount) + same_zip_prior_3yr_branches + 
                           legacy_branch + lag_county_deposit_gr + 
                           lag_hmda_mtg_amt_gr + lag_cra_loan_amount_amt_lt_1m_gr + 
                           lag_establishment_gr + lag_payroll_gr + lmi + 
                           log(lag_bank_county_mortgage_volume) + log(lag_bank_county_cra_volume)| state_yr + bank_yr,
  
  # County-level controls with simplified specification
  ..ctrl_county_closure = ~ log(lag_branch_deposit_amount) + same_zip_prior_3yr_branches + 
                            legacy_branch + log(lag_bank_county_mortgage_volume) + log(lag_bank_county_cra_volume)| county_yr + bank_yr
)

```

## Baseline Closure Model

Relationship between deposit beta and branch closure probability:

```{r}
#| label: tbl-baseline-closure
#| tbl-cap: "Baseline Branch Closure Regressions"

# Run regressions for all banks, large banks, and small banks
closure_regs <- list(
  # All banks
  feols(closed ~ deposit_beta + ..ctrl_state_closure, 
        data = branch_sample, vcov = ~RSSDID),
  feols(closed ~ deposit_beta + ..ctrl_county_closure, 
        data = branch_sample, vcov = ~RSSDID),
  
  # Large banks
  feols(closed ~ deposit_beta + ..ctrl_state_closure, 
        data = branch_sample[large_bank == 1], vcov = ~RSSDID),
  feols(closed ~ deposit_beta + ..ctrl_county_closure, 
        data = branch_sample[large_bank == 1], vcov = ~RSSDID),
  
  # Small banks
  feols(closed ~ deposit_beta + ..ctrl_state_closure, 
        data = branch_sample[large_bank == 0], vcov = ~RSSDID),
  feols(closed ~ deposit_beta + ..ctrl_county_closure, 
        data = branch_sample[large_bank == 0], vcov = ~RSSDID)
)

# Display results
md_table(etable(
  closure_regs,
  se.below = TRUE,
  signif.code = c("***" = 0.01, "**" = 0.05, "*" = 0.10),
  headers = list("All Banks" = 2, "Large Banks" = 2, "Small Banks" = 2),
  dict = c("deposit_beta" = "Deposit beta"),
  depvar = FALSE
))

# LaTeX version (uncomment to use)
# etable(
#   closure_regs,
#   se.below = TRUE,
#   signif.code = c("***" = 0.01, "**" = 0.05, "*" = 0.10),
#   headers = list("All Banks" = 2, "Large Banks" = 2, "Small Banks" = 2),
#   dict = c("deposit_beta" = "Deposit beta"),
#   depvar = FALSE,
#   tex = TRUE,
#   style.tex = style.tex("aer")
# )
```

## Closures by Time Period

Analyze closure patterns across different economic regimes:

```{r}
#| label: tbl-closure-by-regime

# Define year ranges for different economic periods
yr_range <- list(
  "2001-2007" = 2000:2007,  # Pre-crisis
  "2008-2011" = 2008:2011,  # Financial crisis
  "2012-2019" = 2012:2019,  # Post-crisis recovery
  "2020-2023" = 2020:2024   # Pandemic era
)

# Large banks - closures by regime
closure_large_by_regime <- list(
  feols(closed ~ deposit_beta + ..ctrl_state_closure, 
        data = branch_sample[large_bank == 1 & yr %in% yr_range[[1]]], vcov = ~RSSDID),
  feols(closed ~ deposit_beta + ..ctrl_county_closure, 
        data = branch_sample[large_bank == 1 & yr %in% yr_range[[1]]], vcov = ~RSSDID),
  feols(closed ~ deposit_beta + ..ctrl_state_closure, 
        data = branch_sample[large_bank == 1 & yr %in% yr_range[[2]]], vcov = ~RSSDID),
  feols(closed ~ deposit_beta + ..ctrl_county_closure, 
        data = branch_sample[large_bank == 1 & yr %in% yr_range[[2]]], vcov = ~RSSDID),
  feols(closed ~ deposit_beta + ..ctrl_state_closure, 
        data = branch_sample[large_bank == 1 & yr %in% yr_range[[3]]], vcov = ~RSSDID),
  feols(closed ~ deposit_beta + ..ctrl_county_closure, 
        data = branch_sample[large_bank == 1 & yr %in% yr_range[[3]]], vcov = ~RSSDID),
  feols(closed ~ deposit_beta + ..ctrl_state_closure, 
        data = branch_sample[large_bank == 1 & yr %in% yr_range[[4]]], vcov = ~RSSDID),
  feols(closed ~ deposit_beta + ..ctrl_county_closure, 
        data = branch_sample[large_bank == 1 & yr %in% yr_range[[4]]], vcov = ~RSSDID)
)

# Display mean closure rates for large banks
cat("Large banks - Mean closure rates by period:\n")
for(i in 1:length(yr_range)) {
  mean_close <- mean(branch_sample[large_bank == 1 & yr %in% yr_range[[i]]]$closed, na.rm = TRUE)
  cat(names(yr_range)[i], ":", round(mean_close * 100, 3), "%\n")
}

cat("\n")

# Display results
etable(
  closure_large_by_regime,
  se.below = TRUE,
  signif.code = c("***" = 0.01, "**" = 0.05, "*" = 0.10),
  headers = list("2001-07" = 2, "2008-11" = 2, "2012-19" = 2, "2020-23" = 2),
  dict = c("deposit_beta" = "Deposit beta"),
  depvar = FALSE
)

cat("\n\n")

# Small banks - closures by regime
closure_small_by_regime <- list(
  feols(closed ~ deposit_beta + ..ctrl_state_closure, 
        data = branch_sample[large_bank == 0 & yr %in% yr_range[[1]]], vcov = ~RSSDID),
  feols(closed ~ deposit_beta + ..ctrl_county_closure, 
        data = branch_sample[large_bank == 0 & yr %in% yr_range[[1]]], vcov = ~RSSDID),
  feols(closed ~ deposit_beta + ..ctrl_state_closure, 
        data = branch_sample[large_bank == 0 & yr %in% yr_range[[2]]], vcov = ~RSSDID),
  feols(closed ~ deposit_beta + ..ctrl_county_closure, 
        data = branch_sample[large_bank == 0 & yr %in% yr_range[[2]]], vcov = ~RSSDID),
  feols(closed ~ deposit_beta + ..ctrl_state_closure, 
        data = branch_sample[large_bank == 0 & yr %in% yr_range[[3]]], vcov = ~RSSDID),
  feols(closed ~ deposit_beta + ..ctrl_county_closure, 
        data = branch_sample[large_bank == 0 & yr %in% yr_range[[3]]], vcov = ~RSSDID),
  feols(closed ~ deposit_beta + ..ctrl_state_closure, 
        data = branch_sample[large_bank == 0 & yr %in% yr_range[[4]]], vcov = ~RSSDID),
  feols(closed ~ deposit_beta + ..ctrl_county_closure, 
        data = branch_sample[large_bank == 0 & yr %in% yr_range[[4]]], vcov = ~RSSDID)
)

# Display mean closure rates for small banks
cat("Small banks - Mean closure rates by period:\n")
for(i in 1:length(yr_range)) {
  mean_close <- mean(branch_sample[large_bank == 0 & yr %in% yr_range[[i]]]$closed, na.rm = TRUE)
  cat(names(yr_range)[i], ":", round(mean_close * 100, 3), "%\n")
}

cat("\n")

# Display results
md_table(etable(
  closure_small_by_regime,
  se.below = TRUE,
  signif.code = c("***" = 0.01, "**" = 0.05, "*" = 0.10),
  headers = list("2001-07" = 2, "2008-11" = 2, "2012-19" = 2, "2020-23" = 2),
  dict = c("deposit_beta" = "Deposit beta"),
  depvar = FALSE
))

# LaTeX versions (uncomment to use)
# etable(
#   closure_large_by_regime,
#   se.below = TRUE,
#   signif.code = c("***" = 0.01, "**" = 0.05, "*" = 0.10),
#   headers = list("2001-07" = 2, "2008-11" = 2, "2012-19" = 2, "2020-23" = 2),
#   dict = c("deposit_beta" = "Deposit beta"),
#   depvar = FALSE,
#   tex = TRUE,
#   style.tex = style.tex("aer")
# )
# 
# etable(
#   closure_small_by_regime,
#   se.below = TRUE,
#   signif.code = c("***" = 0.01, "**" = 0.05, "*" = 0.10),
#   headers = list("2001-07" = 2, "2008-11" = 2, "2012-19" = 2, "2020-23" = 2),
#   dict = c("deposit_beta" = "Deposit beta"),
#   depvar = FALSE,
#   tex = TRUE,
#   style.tex = style.tex("aer")
# )
```

# Branch Visit Patterns



## Closures and Branch Usage (Pandemic Era)

Examine how changes in branch usage during the pandemic relate to closure decisions:

```{r}
#| label: prepare-branch-usage

# Load branch visit data (SafeGraph)
branch_visits <- readRDS(file.path(data_dir, "bank_branch_visits_count_2019_2022.rds"))
branch_visits[, yr := year(DATE_RANGE_START)]
branch_visits <- branch_visits[yr %in% c(2019, 2021)]

# Load branch characteristics to get zip codes
branch_chars <- readRDS('C:/OneDrive/data/fdic_sod_1995_2025_simple.rds')
branch_chars <- data.table(branch_chars)
if("YEAR" %in% names(branch_chars)) setnames(branch_chars, "YEAR", "yr")
if("ZIPBR" %in% names(branch_chars)) setnames(branch_chars, "ZIPBR", "zip")

# Get unique UNINUMBR-zip combinations (use most recent year for each branch)
branch_zip <- branch_chars[order(UNINUMBR, -yr)][, .SD[1], by = UNINUMBR][, .(UNINUMBR, zip)]

# Merge branch visits with zip codes
branch_visits <- merge(branch_visits, branch_zip, by = "UNINUMBR")

# Calculate average distance from home in 2019 (pre-pandemic baseline)
distance <- branch_visits[yr == 2019, .(distance_km = mean(DISTANCE_FROM_HOME, na.rm = TRUE) / 1000), 
                         by = zip]

# Aggregate visits to zip level for zips with 5+ branches
branch_visits <- branch_visits[, .(no_branches = .N, number_of_visits = sum(RAW_VISIT_COUNTS, na.rm = TRUE)), 
                               by = .(zip, yr)]
branch_visits <- branch_visits[no_branches > 4]

# Calculate change in visits between 2019 and 2021
branch_visits <- dcast(branch_visits, zip ~ yr, value.var = "number_of_visits")
branch_visits[, change_visits := (`2019` - `2021`) / `2019`]

# Merge with distance and winsorize
branch_visits <- merge(branch_visits, distance, by = "zip")
branch_visits[, change_visits := Winsorize(change_visits, 
                                           quantile(change_visits, probs = c(0.01, 0.99), na.rm = TRUE))]
branch_visits[, distance_km := Winsorize(distance_km, 
                                         quantile(distance_km, probs = c(0.01, 0.99), na.rm = TRUE))]
branch_visits[, zip := str_pad(zip, 5, "left", "0")]

cat("Branch usage data prepared for", nrow(branch_visits), "zip codes\n")
```

```{r}
#| label: tbl-closure-usage

# Merge branch sample with usage data for 2020-2023 period
closures <- merge(branch_sample[yr >= 2020], 
                 branch_visits[, c("zip", "change_visits", "distance_km")], 
                 by = "zip")

# Update fixed effects for this subsample
closures[, bank_year := paste(RSSDID, yr)]
closures[, state_year := paste(substr(STCNTYBR, 1, 2), yr)]

# Display mean closure rates
cat("Mean closure rates (2020-2023):\n")
cat("All banks:", round(mean(closures$closed, na.rm = TRUE) * 100, 3), "%\n")
cat("Large banks:", round(mean(closures[large_bank == 1]$closed, na.rm = TRUE) * 100, 3), "%\n")
cat("Small banks:", round(mean(closures[large_bank == 0]$closed, na.rm = TRUE) * 100, 3), "%\n\n")

# Regressions with usage variables
closure_usage_full <- list(
  feols(closed ~ deposit_beta + ..ctrl_state_closure, 
        data = closures, vcov = ~RSSDID),
  feols(closed ~ deposit_beta + ..ctrl_county_closure, 
        data = closures, vcov = ~RSSDID),
  feols(closed ~ deposit_beta + change_visits + log(distance_km) + ..ctrl_state_closure, 
        data = closures, vcov = ~RSSDID),
  feols(closed ~ deposit_beta + change_visits + log(distance_km) + ..ctrl_county_closure, 
        data = closures, vcov = ~RSSDID)
)

cat("Full sample results:\n")
etable(
  closure_usage_full,
  se.below = TRUE,
  signif.code = c("***" = 0.01, "**" = 0.05, "*" = 0.10),
  headers = list("Baseline" = 2, "With Usage" = 2),
  dict = c("deposit_beta" = "Deposit beta", "change_visits" = "Drop in visits", 
           "log(distance_km)" = "Log(Distance)"),
  depvar = FALSE
)

cat("\n\n")

# By bank size
closure_usage_by_size <- list(
  # Large banks
  feols(closed ~ deposit_beta + ..ctrl_state_closure, 
        data = closures[large_bank == 1], vcov = ~RSSDID),
  feols(closed ~ deposit_beta + ..ctrl_county_closure, 
        data = closures[large_bank == 1], vcov = ~RSSDID),
  feols(closed ~ deposit_beta + change_visits + log(distance_km) + ..ctrl_state_closure, 
        data = closures[large_bank == 1], vcov = ~RSSDID),
  feols(closed ~ deposit_beta + change_visits + log(distance_km) + ..ctrl_county_closure, 
        data = closures[large_bank == 1], vcov = ~RSSDID),
  # Small banks
  feols(closed ~ deposit_beta + ..ctrl_state_closure, 
        data = closures[large_bank == 0], vcov = ~RSSDID),
  feols(closed ~ deposit_beta + ..ctrl_county_closure, 
        data = closures[large_bank == 0], vcov = ~RSSDID),
  feols(closed ~ deposit_beta + change_visits + log(distance_km) + ..ctrl_state_closure, 
        data = closures[large_bank == 0], vcov = ~RSSDID),
  feols(closed ~ deposit_beta + change_visits + log(distance_km) + ..ctrl_county_closure, 
        data = closures[large_bank == 0], vcov = ~RSSDID)
)

cat("Results by bank size:\n")
md_table(etable(
  closure_usage_by_size,
  se.below = TRUE,
  signif.code = c("***" = 0.01, "**" = 0.05, "*" = 0.10),
  headers = list("Large Banks" = 4, "Small Banks" = 4),
  dict = c("deposit_beta" = "Deposit beta", "change_visits" = "Drop in visits", 
           "log(distance_km)" = "Log(Distance)"),
  depvar = FALSE
))

# LaTeX versions (uncomment to use)
# etable(
#   closure_usage_full,
#   se.below = TRUE,
#   signif.code = c("***" = 0.01, "**" = 0.05, "*" = 0.10),
#   headers = list("Baseline" = 2, "With Usage" = 2),
#   dict = c("deposit_beta" = "Deposit beta", "change_visits" = "Drop in visits", 
#            "log(distance_km)" = "Log(Distance)"),
#   depvar = FALSE,
#   tex = TRUE,
#   style.tex = style.tex("aer")
# )
```

## Reduced Form: Demographics and Closures

Test whether depositor characteristics directly predict closures (without deposit beta):

```{r}
#| label: tbl-closure-reduced-form

# Coefficient labels
rf_dict <- c(
  "college_frac" = "College frac",
  "dividend_frac" = "Stock market frac",
  "log(family_income)" = "Log(Income)",
  "sophisticated" = "Sophisticated zipcode",
  "factor_age_bin2" = "Age Q1-Q2",
  "factor_age_bin3" = "Age Q2-Q3",
  "factor_age_bin4" = "Age >Q3",
  "lag_county_deposit_hhi" = "County deposit HHI",
  "population_density" = "Population density"
)

# Pooled reduced form regressions
closure_rf <- list(
  feols(closed ~ college_frac + log(family_income) + dividend_frac + factor_age_bin + 
        lag_county_deposit_hhi + population_density + ..ctrl_state_closure,
        data = branch_sample[!is.na(deposit_beta)], vcov = ~RSSDID),
  feols(closed ~ college_frac + log(family_income) + dividend_frac + factor_age_bin + 
        ..ctrl_county_closure,
        data = branch_sample[!is.na(deposit_beta)], vcov = ~RSSDID),
  feols(closed ~ factor_age_bin + log(family_income) + sophisticated + 
        lag_county_deposit_hhi + population_density + ..ctrl_state_closure,
        data = branch_sample[!is.na(deposit_beta)], vcov = ~RSSDID),
  feols(closed ~ factor_age_bin + log(family_income) + sophisticated + 
        ..ctrl_county_closure,
        data = branch_sample[!is.na(deposit_beta)], vcov = ~RSSDID)
)

cat("Pooled reduced form results:\n")
etable(
  closure_rf,
  se.below = TRUE,
  signif.code = c("***" = 0.01, "**" = 0.05, "*" = 0.10),
  dict = rf_dict,
  depvar = FALSE
)

cat("\n\n")

# By bank size
closure_rf_by_size <- list(
  # Large banks - demographics
  feols(closed ~ college_frac + log(family_income) + dividend_frac + factor_age_bin + 
        lag_county_deposit_hhi + population_density + ..ctrl_state_closure,
        data = branch_sample[large_bank == 1 & !is.na(deposit_beta)], vcov = ~RSSDID),
  feols(closed ~ college_frac + log(family_income) + dividend_frac + factor_age_bin + 
        ..ctrl_county_closure,
        data = branch_sample[large_bank == 1 & !is.na(deposit_beta)], vcov = ~RSSDID),
  # Small banks - demographics
  feols(closed ~ college_frac + log(family_income) + dividend_frac + factor_age_bin + 
        lag_county_deposit_hhi + population_density + ..ctrl_state_closure,
        data = branch_sample[large_bank == 0 & !is.na(deposit_beta)], vcov = ~RSSDID),
  feols(closed ~ college_frac + log(family_income) + dividend_frac + factor_age_bin + 
        ..ctrl_county_closure,
        data = branch_sample[large_bank == 0 & !is.na(deposit_beta)], vcov = ~RSSDID),
  # Large banks - sophistication
  feols(closed ~ factor_age_bin + log(family_income) + sophisticated + 
        lag_county_deposit_hhi + population_density + ..ctrl_state_closure,
        data = branch_sample[large_bank == 1 & !is.na(deposit_beta)], vcov = ~RSSDID),
  feols(closed ~ factor_age_bin + log(family_income) + sophisticated + 
        ..ctrl_county_closure,
        data = branch_sample[large_bank == 1 & !is.na(deposit_beta)], vcov = ~RSSDID),
  # Small banks - sophistication
  feols(closed ~ factor_age_bin + log(family_income) + sophisticated + 
        lag_county_deposit_hhi + population_density + ..ctrl_state_closure,
        data = branch_sample[large_bank == 0 & !is.na(deposit_beta)], vcov = ~RSSDID),
  feols(closed ~ factor_age_bin + log(family_income) + sophisticated + 
        ..ctrl_county_closure,
        data = branch_sample[large_bank == 0 & !is.na(deposit_beta)], vcov = ~RSSDID)
)

cat("Results by bank size:\n")
md_table(etable(
  closure_rf_by_size,
  se.below = TRUE,
  signif.code = c("***" = 0.01, "**" = 0.05, "*" = 0.10),
  headers = list("Large Banks" = 4, "Small Banks" = 4),
  dict = rf_dict,
  depvar = FALSE
))

# LaTeX versions (uncomment to use)
# etable(
#   closure_rf,
#   se.below = TRUE,
#   signif.code = c("***" = 0.01, "**" = 0.05, "*" = 0.10),
#   dict = rf_dict,
#   depvar = FALSE,
#   tex = TRUE,
#   style.tex = style.tex("aer")
# )
# 
# etable(
#   closure_rf_by_size,
#   se.below = TRUE,
#   signif.code = c("***" = 0.01, "**" = 0.05, "*" = 0.10),
#   headers = list("Large Banks" = 4, "Small Banks" = 4),
#   dict = rf_dict,
#   depvar = FALSE,
#   tex = TRUE,
#   style.tex = style.tex("aer")
# )
```

# Session Info

```{r}
sessionInfo()
```
